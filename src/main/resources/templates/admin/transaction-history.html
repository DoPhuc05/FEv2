<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Lịch sử giao dịch</title>
    <link rel="stylesheet" href="/public/admin/css/fontawesome.min.css">
    <link rel="stylesheet" type="text/css" href="/public/admin/css/datatables.min.css"/>
    <link href="/public/admin/css/styles.css" rel="stylesheet" />
    <style>
        .pagination .page-item .page-link {
            color: #333;
            font-weight: 500;
            background: #fff;
            border: 1px solid #dee2e6;
            margin: 0 2px;
            min-width: 38px;
            text-align: center;
        }
        .pagination .page-item.active .page-link {
            background-color: #0d6efd;
            color: #fff;
            border-color: #0d6efd;
        }
        .pagination .page-item .page-link:hover {
            background: #f0f0f0;
            color: #0d6efd;
        }
        .pagination .page-item.disabled .page-link {
            color: #aaa;
            background: #f8f9fa;
            border-color: #dee2e6;
        }
        .table td, .table th {
            padding-top: 0.35rem;
            padding-bottom: 0.35rem;
        }
        .btn-sm {
            line-height: 1;
        }
        .table .btn-sm {
          margin-top: 0 !important;
          margin-bottom: 0 !important;
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }
        .table .d-flex {
          flex-direction: row !important;
        }
        .pagination-info {
            text-align: center;
            margin: 10px 0;
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body class="sb-nav-fixed">
<nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
    <a class="navbar-brand ps-3" href="/admin/index">Dashboard Quản trị</a>
    <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle"><i class="fas fa-bars"></i></button>
    <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
        <div class="input-group">
            <input class="form-control" type="text" placeholder="Search for..." />
            <button class="btn btn-primary" type="button"><i class="fas fa-search"></i></button>
        </div>
    </form>
    <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown"><i class="fas fa-user fa-fw"></i></a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item" href="/admin/logout">Logout</a></li>
            </ul>
        </li>
    </ul>
</nav>
<div id="layoutSidenav">
    <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
            <div class="sb-sidenav-menu">
                <div class="nav">
                    <div class="sb-sidenav-menu-heading">Core</div>
                    <a class="nav-link" href="/admin/index">
                        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                        Trang chủ
                    </a>
                    <div class="sb-sidenav-menu-heading">Trang quản lý</div>
                    <a class="nav-link" href="/admin/user">
                        <div class="sb-nav-link-icon"><i class="fas fa-table"></i></div>Quản lý người dùng
                    </a>
                    <a class="nav-link" href="/admin/guides">
                        <div class="sb-nav-link-icon"><i class="fas fa-user-tie"></i></div>Quản lý hướng dẫn viên
                    </a>
                    <a class="nav-link" href="/admin/tour">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>Quản lý tour
                    </a>
                    <a class="nav-link" href="/admin/booking">
                        <div class="sb-nav-link-icon"><i class="fas fa-table"></i></div>Quản lý booking
                    </a>
                    <a class="nav-link" href="/admin/review">
                        <div class="sb-nav-link-icon"><i class="fas fa-star"></i></div>Quản lý đánh giá
                    </a>
                    <a class="nav-link" href="/admin/voucher">
                        <div class="sb-nav-link-icon"><i class="fas fa-ticket-alt"></i></div>Quản lý voucher
                    </a>
                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseTransaction" aria-expanded="false">
                        <div class="sb-nav-link-icon"><i class="fas fa-exchange-alt"></i></div>Quản lý giao dịch
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseTransaction" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link" href="/admin/payment-method">Phương thức thanh toán</a>
                            <a class="nav-link active" href="/admin/transaction-history">Lịch sử giao dịch</a>
                        </nav>
                    </div>
                </div>
            </div>
            <div class="sb-sidenav-footer">
                <div class="small">Logged in as:</div>
                Admin
            </div>
        </nav>
    </div>

    <div id="layoutSidenav_content">
        <main>
            <div class="container-fluid px-4">
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <h1>Lịch sử giao dịch</h1>
                </div>
                <ol class="breadcrumb mb-4">
                    <li class="breadcrumb-item"><a href="/admin/index">Dashboard</a></li>
                    <li class="breadcrumb-item active">Lịch sử giao dịch</li>
                </ol>

                <!-- Thống kê tổng quan -->
                <div class="row">
                    <div class="col-xl-2 col-md-6">
                        <div class="card bg-primary text-white mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="small">Tổng giao dịch</div>
                                        <div class="h4" id="totalTransactions">0</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-exchange-alt fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-6">
                        <div class="card bg-success text-white mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="small">Đã thanh toán</div>
                                        <div class="h4" id="completedTransactions">0</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-check-circle fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-6">
                        <div class="card bg-warning text-white mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="small">Chưa thanh toán</div>
                                        <div class="h4" id="pendingTransactions">0</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-clock fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-6">
                        <div class="card bg-danger text-white mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="small">Đã hủy</div>
                                        <div class="h4" id="cancelledTransactions">0</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-times-circle fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4 col-md-6">
                        <div class="card bg-info text-white mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="small">Tổng doanh thu</div>
                                        <div class="h4" id="totalRevenue">0 VNĐ</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-money-bill-wave fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bộ lọc -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-filter me-1"></i>
                        Bộ lọc
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="khachHangFilter" class="form-label">Khách hàng</label>
                                <input type="text" class="form-control" id="khachHangFilter" placeholder="Tên khách hàng">
                            </div>
                            <div class="col-md-3">
                                <label for="trangThaiFilter" class="form-label">Trạng thái</label>
                                <select class="form-select" id="trangThaiFilter">
                                    <option value="">Tất cả</option>
                                    <option value="Đã thanh toán">Đã thanh toán</option>
                                    <option value="Chưa thanh toán">Chưa thanh toán</option>
                                    <option value="Đã hủy">Đã hủy</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="maNoiDungFilter" class="form-label">Mã nội dung</label>
                                <input type="text" class="form-control" id="maNoiDungFilter" placeholder="Mã nội dung">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="filterTransactions()">
                                        <i class="fas fa-search me-1"></i>Lọc
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                                        <i class="fas fa-times me-1"></i>Xóa lọc
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bảng giao dịch -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-table me-1"></i>
                        Danh sách giao dịch
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>STT</th>
                                        <th>Mã nội dung chuyển khoản</th>
                                        <th>Khách hàng</th>
                                        <th>Số tiền</th>
                                        <th>Thời gian</th>
                                        <th>Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionTableBody">
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Phân trang -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <span>Hiển thị <span id="startRecord">0</span> - <span id="endRecord">0</span> của <span id="totalRecords">0</span> giao dịch</span>
                            </div>
                            <nav>
                                <ul class="pagination mb-0" id="transactionHistoryPagination">
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="py-4 bg-light mt-auto">
            <div class="container-fluid px-4">
                <div class="d-flex align-items-center justify-content-between small">
                    <div class="text-muted">&copy; 2025 Travel Admin</div>
                </div>
            </div>
        </footer>
    </div>
</div>
<script src="/public/admin/js/jquery.js"></script>
<script src="/public/admin/js/boostrap-bundle.min.js"></script>
<script src="/public/admin/js/scripts.js"></script>
<script src="/public/admin/js/datatables.min.js"></script>
<script src="/public/admin/js/all.min.js"></script>
<script src="/public/admin/js/ckeditor.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Biến phân trang
    let currentPage = 0;
    let pageSize = 10;
    let totalRecords = 0;
    let allTransactions = [];
    let filteredTransactions = [];

    $(document).ready(function() {
        loadTransactionTable();
        loadStatistics();
    });
    
    function loadTransactionTable(filters = {}) {
        let url = '/api/transaction/table';
        let params = new URLSearchParams();
        
        if (filters.khachHang) params.append('khachHang', filters.khachHang);
        if (filters.trangThai) params.append('trangThai', filters.trangThai);
        if (filters.maNoiDung) params.append('maNoiDung', filters.maNoiDung);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        $.ajax({
            url: url,
            method: 'GET',
            success: function(response) {
                if (response.data) {
                    allTransactions = response.data;
                    filteredTransactions = response.data;
                    totalRecords = response.data.length;
                    currentPage = 0;
                    renderTransactionTable();
                    renderPagination();
                    updatePaginationInfo();
                    
                    // Cập nhật thống kê từ dữ liệu mới
                    updateStatisticsFromTable();
                }
            },
            error: function() {
                console.error('Lỗi khi tải dữ liệu giao dịch');
                allTransactions = [];
                filteredTransactions = [];
                totalRecords = 0;
                renderTransactionTable();
                renderPagination();
                updatePaginationInfo();
                
                // Cập nhật thống kê khi có lỗi
                updateStatisticsFromTable();
            }
        });
    }
    
    function renderTransactionTable() {
        const tbody = $('#transactionTableBody');
        tbody.empty();
        
        if (filteredTransactions.length === 0) {
            tbody.append('<tr><td colspan="6" class="text-center">Không có dữ liệu giao dịch</td></tr>');
            return;
        }
        
        const startIndex = currentPage * pageSize;
        const endIndex = Math.min(startIndex + pageSize, filteredTransactions.length);
        const pageData = filteredTransactions.slice(startIndex, endIndex);
        
        pageData.forEach(function(transaction, index) {
            const globalIndex = startIndex + index;
            const row = `
                <tr>
                    <td class="text-center">${globalIndex + 1}</td>
                    <td><span class="badge bg-primary">${transaction[1]}</span></td>
                    <td>${transaction[2]}</td>
                    <td>${formatCurrency(transaction[3])}</td>
                    <td>${formatDateTime(transaction[4])}</td>
                    <td class="text-center">${getStatusBadge(transaction[5])}</td>
                </tr>
            `;
            tbody.append(row);
        });
    }
    
    function renderPagination() {
        let totalPages = Math.ceil(filteredTransactions.length / pageSize);
        let paginationHtml = '';
        
        if (totalPages === 0) {
            paginationHtml = '<li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>';
            paginationHtml += '<li class="page-item active"><a class="page-link" href="#">1</a></li>';
            paginationHtml += '<li class="page-item disabled"><a class="page-link" href="#">Next</a></li>';
        } else {
            // Previous button
            paginationHtml += `<li class="page-item${currentPage === 0 ? ' disabled' : ''}"><a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a></li>`;
            
            // Page numbers - chỉ hiển thị 1 số trang ở giữa
            if (totalPages === 1) {
                paginationHtml += '<li class="page-item active"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>';
            } else if (totalPages === 2) {
                paginationHtml += `<li class="page-item${currentPage === 0 ? ' active' : ''}"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>`;
                paginationHtml += `<li class="page-item${currentPage === 1 ? ' active' : ''}"><a class="page-link" href="#" onclick="changePage(2)">2</a></li>`;
            } else {
                // Hiển thị 1 số trang ở giữa
                if (currentPage === 0) {
                    paginationHtml += '<li class="page-item active"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>';
                    paginationHtml += '<li class="page-item"><a class="page-link" href="#" onclick="changePage(2)">2</a></li>';
                } else if (currentPage === totalPages - 1) {
                    paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages - 1})">${totalPages - 1}</a></li>`;
                    paginationHtml += `<li class="page-item active"><a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a></li>`;
                } else {
                    paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage})">${currentPage + 1}</a></li>`;
                }
            }
            
            // Next button
            paginationHtml += `<li class="page-item${currentPage === totalPages - 1 ? ' disabled' : ''}"><a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a></li>`;
        }
        
        document.getElementById('transactionHistoryPagination').innerHTML = paginationHtml;
    }
    
    function changePage(page) {
        const totalPages = Math.ceil(filteredTransactions.length / pageSize);
        if (page >= 0 && page < totalPages) {
            currentPage = page;
            renderTransactionTable();
            renderPagination();
            updatePaginationInfo();
        }
    }
    
    function updatePaginationInfo() {
        const startRecord = filteredTransactions.length > 0 ? currentPage * pageSize + 1 : 0;
        const endRecord = Math.min((currentPage + 1) * pageSize, filteredTransactions.length);
        $('#startRecord').text(startRecord);
        $('#endRecord').text(endRecord);
        $('#totalRecords').text(filteredTransactions.length);
    }
    
    function loadStatistics() {
        $.ajax({
            url: '/api/transaction/statistics',
            method: 'GET',
            success: function(response) {
                if (response.data) {
                    $('#totalTransactions').text(response.data.totalTransactions);
                    $('#completedTransactions').text(response.data.completedTransactions);
                    $('#pendingTransactions').text(response.data.pendingTransactions);
                    $('#cancelledTransactions').text(response.data.cancelledTransactions);
                    $('#totalRevenue').text(formatCurrency(response.data.totalRevenue));
                }
            },
            error: function() {
                console.error('Lỗi khi tải thống kê');
            }
        });
    }
    
    // Hàm cập nhật thống kê từ dữ liệu bảng đã được lọc
    function updateStatisticsFromTable() {
        if (!filteredTransactions || filteredTransactions.length === 0) {
            $('#totalTransactions').text('0');
            $('#completedTransactions').text('0');
            $('#pendingTransactions').text('0');
            $('#cancelledTransactions').text('0');
            $('#totalRevenue').text(formatCurrency(0));
            return;
        }

        const total = filteredTransactions.length;
        const completed = filteredTransactions.filter(t => t[5] === 'Đã thanh toán').length;
        const pending = filteredTransactions.filter(t => t[5] === 'Chưa thanh toán').length;
        const cancelled = filteredTransactions.filter(t => t[5] === 'Đã hủy').length;

        // Tính tổng doanh thu từ các giao dịch đã thanh toán
        const totalRevenue = filteredTransactions
            .filter(t => t[5] === 'Đã thanh toán')
            .reduce((sum, t) => sum + (parseFloat(t[3]) || 0), 0);

        $('#totalTransactions').text(total);
        $('#completedTransactions').text(completed);
        $('#pendingTransactions').text(pending);
        $('#cancelledTransactions').text(cancelled);
        $('#totalRevenue').text(formatCurrency(totalRevenue));

        console.log('Thống kê từ bảng đã lọc:', {
            total,
            completed,
            pending,
            cancelled,
            totalRevenue: formatCurrency(totalRevenue)
        });
    }
    
    function filterTransactions() {
        const filters = {
            khachHang: $('#khachHangFilter').val(),
            trangThai: $('#trangThaiFilter').val(),
            maNoiDung: $('#maNoiDungFilter').val()
        };
        
        // Lọc dữ liệu local
        filteredTransactions = allTransactions.filter(transaction => {
            let match = true;
            
            if (filters.khachHang && !transaction[2].toLowerCase().includes(filters.khachHang.toLowerCase())) {
                match = false;
            }
            
            if (filters.trangThai && transaction[5] !== filters.trangThai) {
                match = false;
            }
            
            if (filters.maNoiDung && !transaction[1].toLowerCase().includes(filters.maNoiDung.toLowerCase())) {
                match = false;
            }
            
            return match;
        });
        
        totalRecords = filteredTransactions.length;
        currentPage = 0;
        renderTransactionTable();
        renderPagination();
        updatePaginationInfo();
        
        // Cập nhật thống kê sau khi lọc
        updateStatisticsFromTable();
    }
    
    function clearFilters() {
        $('#khachHangFilter').val('');
        $('#trangThaiFilter').val('');
        $('#maNoiDungFilter').val('');
        filteredTransactions = [...allTransactions];
        totalRecords = filteredTransactions.length;
        currentPage = 0;
        renderTransactionTable();
        renderPagination();
        updatePaginationInfo();
        
        // Cập nhật thống kê sau khi xóa lọc
        updateStatisticsFromTable();
    }
    
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }
    
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('vi-VN');
    }
    
    function getStatusBadge(status) {
        switch(status) {
            case 'Đã thanh toán':
                return '<span class="badge bg-success">Đã thanh toán</span>';
            case 'Chưa thanh toán':
                return '<span class="badge bg-warning">Chưa thanh toán</span>';
            case 'Đã hủy':
                return '<span class="badge bg-danger">Đã hủy</span>';
            default:
                return '<span class="badge bg-secondary">' + status + '</span>';
        }
    }
</script>
</body>
</html>



